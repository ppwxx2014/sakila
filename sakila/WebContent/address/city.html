<!DOCTYPE html>
<html>
<head>
<title>City</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
	body {
		padding: 0;
		margin: 0;
		width: 100%;
		height: 100%;
		overflow: hidden;
		background-position: 0 0;
		background-repeat: no-repeat;
		background-attachment: fixed;
		background-size: cover;
		position: relative;
		overflow-y: auto;
	}
	
	#aside {
		width: 200px;
		height: 3000px;
		position: fixed;
		background: orange;
		overflow: hidden;
		float: left;
	}
	
	#section {
		margin-left: 300px;
		margin-bottom: 100px;
		background: white;
	}
	
	.dan {
		display: inline;
	}
</style>
</head>
<body>
	<div id="aside">
		<h1>MENU</h1>
	</div>
	<div id="section">
		<h1>CITY</h1>
		<h2>city 추가</h2>
		
		<div>
			<div class = "dan">
				country 목록 : 
				<select size = "10" id = "countryList">
			
				</select>
			</div>
			<div class = "dan">
				country id :
				<input type = "text" id = "countryId" readonly = "readonly">				
				city :
				<input type = "text" id = "city">
				<button type = "button" id = "addCity">추가하기</button>
			</div>
		</div>
		
		<div>
		<!-- 도시 목록 보기 -->
		<h2>city 목록</h2>
		<div>
			<table border = "1">
				<thead>
					<tr>
						<th>city_id</th>
						<th>city</th>
						<th>last_update</th>
						<th>countryId</th>
						<th>country</th> <!-- city inner join country -->
					</tr>
				</thead>
				<tbody id = "list">
				</tbody>
			</table>
		</div>
		<button type = "button" id = "preBtn">이전</button>
		<button type = "button" id = "nextBtn">다음</button>
		</div>
	</div>
</body>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script>
		// aside.html include
		$("#aside").load("/sakila/aside.html");
		$.ajax({
			url : "/sakila/selectCountryListAll",
			method : "post",
			success : function(json) {
				console.log(json);
				// <select id = "countryList">사이에  <option>추가
				$("#countryList").empty();
				for(let c of json) {
					$("#countryList").append("<option value = '"+c.countryId+"'>"+c.country+"</option>");
				}
			}
		});
		
		$("#countryList").change(function() {
			$("#countryId").val($("#countryList").val());
		});
		
		
		$("#addCity").click(function() {
			if($("#countryId").val() === "" || $("#city").val() === "") {
				alert("입력입력입력");
				
			} else {
				$.ajax({
					url : "/sakila/address/insertCity",
					method : "post",
					data : {countryId : $("#countryId").val(), city : $("#city").val()},
					success : function() {
						console.log("success!");
						currentPage = 1;
						$("#list").empty(); // 요청 중복을 막기 위해 청소
						$.ajax({
							url : "/sakila/address/selectCityList",
							method : "post",
							data : {"currentPage" : currentPage},
							success : function(json) { // 성공했을시
								window.location.reload();
								// console.log(json);
								for(let i = 0; json.length; i++) {
									let html = "<tr>";
									html += "<td>"+json[i].cityId+"</td>";
									html += "<td>"+json[i].city+"</td>";
									html += "<td>"+json[i].lastUpdate+"</td>";
									html += "<td>"+json[i].country.countryId+"</td>";
									html += "<td>"+json[i].country.country+"</td>";			
									html += "</tr>";
									// tbody안에 저장
									$("#list").append(html);
								}
							}
						});
					}
				});
			}//
		});
		
	</script>

	<script>
		// 첫페이지
		let currentPage = 1;
		
		$.ajax({
			url : "/sakila/address/selectCityList",
			method : "post",
			data : {"currentPage" : currentPage},
			success : function(json) { // 성공했을시
				// console.log(json);
				for(let i = 0; json.length; i++) {
					let html = "<tr>";
					html += "<td>"+json[i].cityId+"</td>";
					html += "<td>"+json[i].city+"</td>";
					html += "<td>"+json[i].lastUpdate+"</td>";
					html += "<td>"+json[i].country.countryId+"</td>";
					html += "<td>"+json[i].country.country+"</td>";			
					html += "</tr>";
					// tbody안에 저장
					$("#list").append(html);
				}
			}
		});
		
		// 이전버튼
		$("#preBtn").click(function() {
			if(currentPage === 1) {
				alert("현재 1페이지입니다.");
				return;
			}
		
		currentPage--;
		console.log(currentPage);
		
		$("#list").empty(); // 요청 중복을 막기 위해 청소
		$.ajax({
			url : "/sakila/address/selectCityList",
			method : "post",
			data : {"currentPage" : currentPage},
			success : function(json) { // 성공했을시
				console.log(json);
				for(let i = 0; json.length; i++) {
					let html = "<tr>";
					html += "<td>"+json[i].cityId+"</td>";
					html += "<td>"+json[i].city+"</td>";
					html += "<td>"+json[i].country.countryId+"</td>";
					html += "<td>"+json[i].country.country+"</td>";			
					html += "<td>"+json[i].lastUpdate+"</td>";
					html += "</tr>";
					// tbody안에 저장
					$("#list").append(html);
					}
				}
			});
		});
		// 다음버튼
		$("#nextBtn").click(function() {
			let count = 0;
			$.ajax({
				url : "/sakila/address/selectCityCount",
				method : "post",
				// 비동기화
				async : false,
				success : function(json) { // 성공했을시
					console.log(json);
					count = Number(json);
				}
			});
			
			// 마지막 페이지
			let lastPage = Math.ceil(count/10);
			if(currentPage == lastPage) {
				alert("마지막 페이지입니다!");
				return;
			}
			
			currentPage++;
			console.log(currentPage);
			
			$("#list").empty(); // 요청 중복을 막기 위해 청소
			$.ajax({
				url : "/sakila/address/selectCityList",
				method : "post",
				data : {"currentPage" : currentPage},
				success : function(json) { // 성공했을시
					console.log(json);
					for(let i = 0; json.length; i++) {
						let html = "<tr>";
						html += "<td>"+json[i].cityId+"</td>";
						html += "<td>"+json[i].city+"</td>";
						html += "<td>"+json[i].country.countryId+"</td>";
						html += "<td>"+json[i].country.country+"</td>";			
						html += "<td>"+json[i].lastUpdate+"</td>";
						html += "</tr>";
						
						// tbody안에 저장
						$("#list").append(html);
						
					}
				}
			});
		});
		
	</script>
</html>










